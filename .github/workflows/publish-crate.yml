name: Publish to crates.io

on:
  push:
    branches:
      - main
    paths:
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'src/**'

permissions:
  contents: read

jobs:
  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    # Only run if the push came from staging branch
    if: github.event.before != '0000000000000000000000000000000000000000'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Check if merged from staging
        id: check_branch
        run: |
          # Get the merge commit message
          COMMIT_MSG=$(git log -1 --pretty=%B)
          
          # Check if this is a merge from staging
          if echo "$COMMIT_MSG" | grep -qE "Merge.*staging.*into.*main"; then
            echo "is_staging_merge=true" >> $GITHUB_OUTPUT
            echo "✓ Detected merge from staging to main"
          else
            echo "is_staging_merge=false" >> $GITHUB_OUTPUT
            echo "✗ Not a merge from staging, skipping publish"
          fi
      
      - name: Install Rust toolchain
        if: steps.check_branch.outputs.is_staging_merge == 'true'
        uses: dtolnay/rust-toolchain@stable
      
      - name: Check if version changed
        if: steps.check_branch.outputs.is_staging_merge == 'true'
        id: check_version
        run: |
          CURRENT_VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].version')
          
          # Check if this version exists on crates.io
          CRATE_NAME=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].name')
          
          if cargo search "$CRATE_NAME" --limit 1 | grep -q "= $CURRENT_VERSION"; then
            echo "version_changed=false" >> $GITHUB_OUTPUT
            echo "Version $CURRENT_VERSION already exists on crates.io"
          else
            echo "version_changed=true" >> $GITHUB_OUTPUT
            echo "New version $CURRENT_VERSION detected"
          fi
      
      - name: Run tests
        if: steps.check_branch.outputs.is_staging_merge == 'true' && steps.check_version.outputs.version_changed == 'true'
        run: cargo test --all-features
      
      - name: Publish to crates.io
        if: steps.check_branch.outputs.is_staging_merge == 'true' && steps.check_version.outputs.version_changed == 'true'
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          echo "Publishing to crates.io..."
          cargo publish --token "${CARGO_REGISTRY_TOKEN}"
